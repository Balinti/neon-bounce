<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Neon Bounce - Free HTML5 Game</title>
<meta name="description" content="Play Neon Bounce - Tap to bounce a glowing ball between neon platforms. Miss a platform and fall into the void. Platforms get narrower as score increases.">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#070814">
<meta property="og:type" content="website">
<meta property="og:title" content="Neon Bounce - Free HTML5 Game">
<meta property="og:description" content="Tap to flip gravity and bounce between neon surfaces. Chase perfects and trigger Pulse Dash!">
<meta property="og:url" content="https://balinti.github.io/neon-bounce/">
<meta property="og:image" content="https://balinti.github.io/neon-bounce/og-image.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Neon Bounce - Free HTML5 Game">
<meta name="twitter:description" content="Tap to flip gravity and bounce between neon surfaces. Chase perfects and trigger Pulse Dash!">
<meta name="twitter:image" content="https://balinti.github.io/neon-bounce/og-image.png">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4099346100621490" crossorigin="anonymous"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;height:100svh;overflow-x:hidden;background:#070814;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;color:#c0c8e0;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
#game-wrap{width:100%;max-width:420px;margin:0 auto;display:flex;flex-direction:column;align-items:center;min-height:100%;min-height:100svh}
canvas{display:block;width:100%;max-width:420px;max-height:750px;touch-action:manipulation;cursor:pointer}
#mute-btn{position:fixed;top:8px;right:8px;z-index:10;background:rgba(20,20,40,.7);border:1px solid rgba(100,120,255,.25);color:#8090cc;font-size:16px;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:manipulation;line-height:1}
#info{max-width:420px;margin:20px auto;padding:0 16px 40px;line-height:1.7;font-size:14px}
#info h2{color:#7080ff;font-size:17px;margin:18px 0 6px}
#info p{margin-bottom:8px;color:#8090aa}
#info strong{color:#a0b0ff}
</style>
</head>
<body>
<div id="game-wrap">
<canvas id="c"></canvas>
</div>
<button id="mute-btn" title="Toggle Sound">&#128263;</button>
<section id="info">
<h2>How to Play</h2>
<p><strong>Tap</strong> the screen or press <strong>Space / Enter</strong> to flip gravity. Your glowing ball moves left and right inside a neon tunnel, bouncing off the walls. Land on the ceiling and floor surfaces to survive and score points!</p>
<h2>Perfect Cores</h2>
<p>Each surface has a bright <strong>core strip</strong> in the center. Land on the core for a <strong>Perfect</strong> hit that builds your combo multiplier. Miss the core but still land on the surface &mdash; you survive, but your combo resets.</p>
<h2>Pulse Dash</h2>
<p>Some surfaces glow with a <strong>charge rail</strong> pattern. Land on them to fill your <strong>Pulse meter</strong>. When the meter is full, flip while you are inside a gap (not on a surface) to trigger <strong>Pulse Dash</strong> &mdash; brief slow motion, a score burst, and a trail of particles!</p>
<h2>Tips</h2>
<p>Surfaces get narrower and gaps get tighter as your score climbs. Time your taps carefully. Chase Perfect landings for massive combo multipliers. Save Pulse Dash for tricky sections where points matter most.</p>
</section>
<script>
(function(){
"use strict";

/* ═══════════════════════════════════════════
   CANVAS + HI-DPI
   ═══════════════════════════════════════════ */
var cvs=document.getElementById("c"),ctx=cvs.getContext("2d");
var DPR=Math.min(window.devicePixelRatio||1,2);
var W,H;
function resize(){
  var wrap=document.getElementById("game-wrap");
  W=Math.min(wrap.clientWidth,420);
  H=Math.min(window.innerHeight,750);
  cvs.width=W*DPR;cvs.height=H*DPR;
  cvs.style.width=W+"px";cvs.style.height=H+"px";
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
resize();window.addEventListener("resize",resize);

/* ═══════════════════════════════════════════
   AUDIO (WebAudio oscillators, muted by default)
   ═══════════════════════════════════════════ */
var aCtx=null,muted=true;
var muteBtn=document.getElementById("mute-btn");
muteBtn.textContent="\u{1F507}";
function initAudio(){if(!aCtx)try{aCtx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}}
function tone(f,d,t,v){
  if(muted||!aCtx)return;
  try{var o=aCtx.createOscillator(),g=aCtx.createGain();
  o.type=t||"sine";o.frequency.value=f;
  g.gain.setValueAtTime(v||.06,aCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,aCtx.currentTime+d);
  o.connect(g);g.connect(aCtx.destination);o.start();o.stop(aCtx.currentTime+d)}catch(e){}}
function sndBounce(){tone(380,.08,"sine",.05)}
function sndPerfect(){tone(800,.12,"sine",.07);setTimeout(function(){tone(1050,.1,"sine",.05)},70)}
function sndDash(){tone(200,.3,"sawtooth",.06);tone(300,.25,"triangle",.04)}
function sndDeath(){tone(110,.5,"sawtooth",.08);tone(70,.6,"square",.05)}
muteBtn.addEventListener("click",function(e){e.stopPropagation();initAudio();muted=!muted;muteBtn.textContent=muted?"\u{1F507}":"\u{1F509}"});

/* ═══════════════════════════════════════════
   PRNG (LCG, seeded per run)
   ═══════════════════════════════════════════ */
var seed=1;
function prng(){seed=(seed*1664525+1013904223)&0xFFFFFFFF;return(seed>>>0)/4294967295}

/* ═══════════════════════════════════════════
   CONSTANTS
   ═══════════════════════════════════════════ */
var FDT=1/120;
var BALL_R=7;
var GRAV=2200;
var BALL_SPD=110;
var MAX_PARTS=220;
var PULSE_NEED=5;
var COMBO_CAP=20;
var WALL_PAD=12;
var CEIL=55;
var SURF_H=8;

/* ═══════════════════════════════════════════
   GAME STATE
   ═══════════════════════════════════════════ */
var state="start";
var score,bestScore,combo,maxCombo,perfects,totalLands;
var bx,by,bvx,bvy,gravDir,dirX;
var surfs,scrollSpd,nextSurfT,surfIdCtr;
var parts,pops,shards;
var pulseChg,pulsing,pulseT;
var shkX,shkY,shkDur;
var slowMo,slowT;
var acc,hue,floorY,gtime;
var deathInfo;
var runSeed;

bestScore=parseInt(localStorage.getItem("nb_best2"))||0;

function resetGame(){
  runSeed=Date.now()&0xFFFFFF;seed=runSeed;
  score=0;combo=0;maxCombo=0;perfects=0;totalLands=0;
  floorY=H-55;
  bx=W/2;by=(CEIL+floorY)/2;bvx=BALL_SPD;bvy=0;
  gravDir=1;dirX=1;
  surfs=[];parts=[];pops=[];shards=[];
  scrollSpd=60;nextSurfT=0;surfIdCtr=0;
  pulseChg=0;pulsing=false;pulseT=0;
  shkX=0;shkY=0;shkDur=0;
  slowMo=1;slowT=0;
  acc=0;hue=200;gtime=0;
  deathInfo=null;
  genInitial();
}

/* ═══════════════════════════════════════════
   SURFACE GENERATION
   ═══════════════════════════════════════════ */
function diff(){return Math.min(score/100,1)}

function genSurf(x){
  var d=diff();
  var minW=70-d*25,maxW=150-d*50;
  var w=minW+prng()*(maxW-minW);
  if(w<30)w=30;
  var isTop=prng()<.5;
  var coreW=Math.max(8,w*(.32-d*.1));
  var isCharge=prng()<.2;
  var h2=170+prng()*150;
  surfIdCtr++;
  return{id:surfIdCtr,x:x,isTop:isTop,w:w,coreW:coreW,isCharge:isCharge,hit:false,hue:h2}
}

function genInitial(){
  surfs=[];
  // first surface under ball (floor)
  surfIdCtr++;
  surfs.push({id:surfIdCtr,x:W/2-55,isTop:false,w:110,coreW:30,isCharge:false,hit:false,hue:220});
  var nx=W/2+90;
  for(var i=0;i<10;i++){
    surfs.push(genSurf(nx));
    nx+=90+prng()*70;
  }
}

/* ═══════════════════════════════════════════
   PARTICLES / EFFECTS
   ═══════════════════════════════════════════ */
function addPart(x,y,col,n,sm){
  sm=sm||1;
  for(var i=0;i<n&&parts.length<MAX_PARTS;i++){
    var a=Math.random()*6.2832,s=(25+Math.random()*70)*sm;
    parts.push({x:x,y:y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,
      life:.3+Math.random()*.5,ml:.3+Math.random()*.5,
      r:1.5+Math.random()*3,col:col})
  }
}
function addPop(x,y,txt,col,sz){
  pops.push({x:x,y:y,txt:txt,col:col,sz:sz||16,life:.8,ml:.8,vy:-55})
}
function addShards(x,y,n){
  for(var i=0;i<n;i++){
    var a=Math.random()*6.2832,s=50+Math.random()*180;
    shards.push({x:x,y:y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-40,
      rot:Math.random()*6.28,rv:(Math.random()-.5)*10,
      w:3+Math.random()*7,h:1+Math.random()*3,
      life:.8+Math.random()*.6,ml:1.4,hue:hue+Math.random()*60})
  }
}

/* ═══════════════════════════════════════════
   INPUT
   ═══════════════════════════════════════════ */
var tapQ=false;
function onTap(){
  initAudio();
  if(state==="start"){resetGame();state="playing";return}
  if(state==="gameover"){if(shkDur<=0){state="start"}return}
  if(state==="playing")tapQ=true;
}
cvs.addEventListener("pointerdown",function(e){e.preventDefault();onTap()});
document.addEventListener("keydown",function(e){
  if(e.code==="Space"||e.code==="Enter"){e.preventDefault();onTap()}
});

/* ═══════════════════════════════════════════
   FIXED-STEP UPDATE
   ═══════════════════════════════════════════ */
function step(dt){
  if(state!=="playing")return;
  gtime+=dt;hue=(hue+dt*18)%360;

  var tm=slowMo;
  var adt=dt*tm;

  // timers
  if(slowT>0){slowT-=dt;if(slowT<=0)slowMo=1}
  if(pulsing){pulseT-=dt;if(pulseT<=0){pulsing=false;slowMo=1}}
  if(shkDur>0){shkDur-=dt;shkX=(Math.random()-.5)*shkDur*90;shkY=(Math.random()-.5)*shkDur*90;if(shkDur<=0){shkX=0;shkY=0}}

  // handle tap -> flip gravity
  if(tapQ){
    tapQ=false;
    gravDir*=-1;

    // pulse dash check: if pulse full and in a gap
    if(pulseChg>=PULSE_NEED&&!pulsing){
      var inGap=true;
      for(var i=0;i<surfs.length;i++){
        var s=surfs[i];
        var sy=s.isTop?CEIL:floorY;
        if(bx>=s.x&&bx<=s.x+s.w&&Math.abs(by-sy)<BALL_R+SURF_H+5){inGap=false;break}
      }
      if(inGap){
        pulsing=true;pulseT=1.0;pulseChg=0;
        slowMo=.35;slowT=1.0;
        var mult=1+Math.floor(combo/3);
        score+=5*mult;
        sndDash();
        addPart(bx,by,"hsl("+((hue+40)%360)+",100%,70%)",25,2);
        addPop(bx,by-28,"PULSE DASH!","#fff",20);
        shkDur=.18;
      }
    }

    bvy=gravDir*250;
    sndBounce();
  }

  // gravity
  bvy+=GRAV*gravDir*adt;
  by+=bvy*adt;

  // horizontal movement + wall bounce
  bx+=BALL_SPD*dirX*adt;
  if(bx<WALL_PAD+BALL_R){bx=WALL_PAD+BALL_R;dirX=1}
  if(bx>W-WALL_PAD-BALL_R){bx=W-WALL_PAD-BALL_R;dirX=-1}

  // scroll surfaces leftward
  var spd=scrollSpd+diff()*35;
  for(var i=0;i<surfs.length;i++)surfs[i].x-=spd*adt;

  // surface collision
  var onSurf=false;
  for(var i=surfs.length-1;i>=0;i--){
    var s=surfs[i];
    if(s.hit)continue;
    if(bx<s.x||bx>s.x+s.w)continue;
    var sy=s.isTop?CEIL:floorY;
    if(s.isTop){
      if(gravDir===-1&&bvy<0&&by-BALL_R<=sy+SURF_H){
        by=sy+SURF_H+BALL_R;bvy=0;onSurf=true;
        doLand(s);break;
      }
    }else{
      if(gravDir===1&&bvy>0&&by+BALL_R>=sy-SURF_H){
        by=sy-SURF_H-BALL_R;bvy=0;onSurf=true;
        doLand(s);break;
      }
    }
  }

  // death: hit ceiling/floor without surface
  if(!onSurf){
    if(gravDir===-1&&by-BALL_R<=CEIL){
      // check if on a top surface
      var saved=false;
      for(var i=0;i<surfs.length;i++){
        var s=surfs[i];
        if(!s.hit&&s.isTop&&bx>=s.x&&bx<=s.x+s.w){saved=true;break}
      }
      if(!saved){die("Smacked the ceiling!");return}
    }
    if(gravDir===1&&by+BALL_R>=floorY){
      var saved2=false;
      for(var i=0;i<surfs.length;i++){
        var s=surfs[i];
        if(!s.hit&&!s.isTop&&bx>=s.x&&bx<=s.x+s.w){saved2=true;break}
      }
      if(!saved2){die("Fell into the void!");return}
    }
  }

  // gen new surfaces
  nextSurfT-=adt;
  if(nextSurfT<=0){
    var mx=0;
    for(var i=0;i<surfs.length;i++){var ex=surfs[i].x+surfs[i].w;if(ex>mx)mx=ex}
    if(mx<W+150)surfs.push(genSurf(mx+50+prng()*70));
    nextSurfT=.2+prng()*.25;
  }

  // cleanup off-screen
  while(surfs.length>0&&surfs[0].x+surfs[0].w<-50)surfs.shift();

  // update particles
  for(var i=parts.length-1;i>=0;i--){
    var p=parts[i];p.x+=p.vx*adt;p.y+=p.vy*adt;p.vy+=180*adt;
    p.life-=adt;if(p.life<=0)parts.splice(i,1);
  }
  for(var i=pops.length-1;i>=0;i--){
    var t=pops[i];t.y+=t.vy*adt;t.life-=adt;if(t.life<=0)pops.splice(i,1);
  }
  for(var i=shards.length-1;i>=0;i--){
    var s=shards[i];s.x+=s.vx*adt;s.y+=s.vy*adt;s.vy+=250*adt;
    s.rot+=s.rv*adt;s.life-=adt;if(s.life<=0)shards.splice(i,1);
  }

  // difficulty ramp
  scrollSpd=60+score*.4;

  // ball trail
  if(Math.random()<.55&&parts.length<MAX_PARTS){
    var th=pulsing?(hue+50)%360:hue;
    parts.push({x:bx,y:by,vx:(Math.random()-.5)*8,vy:(Math.random()-.5)*8,
      life:pulsing?.45:.2,ml:pulsing?.45:.2,r:pulsing?3.5:2,col:"hsl("+th+",100%,60%)"})
  }
}

function doLand(s){
  s.hit=true;totalLands++;score++;
  var cx=s.x+s.w/2;
  var dist=Math.abs(bx-cx);
  if(dist<=s.coreW/2){
    combo++;perfects++;if(combo>maxCombo)maxCombo=combo;
    var m=Math.min(combo,COMBO_CAP);score+=m;
    sndPerfect();
    addPart(bx,by,"hsl(55,100%,70%)",14,1.4);
    addPop(bx,by-22,"PERFECT x"+m,"#ffe066",18);
    shkDur=.06;
  }else{
    combo=0;sndBounce();
    addPart(bx,by,"hsl("+s.hue+",80%,55%)",5,.7);
  }
  if(s.isCharge&&pulseChg<PULSE_NEED){
    pulseChg=Math.min(pulseChg+1,PULSE_NEED);
    addPop(bx,by-14,"+CHARGE","#aaffff",13);
  }
}

function die(reason){
  state="gameover";sndDeath();
  if(score>bestScore){bestScore=score;localStorage.setItem("nb_best2",bestScore)}
  deathInfo={reason:reason,combo:maxCombo,rate:totalLands>0?Math.round(perfects/totalLands*100):0};
  addShards(bx,by,22);addPart(bx,by,"hsl(0,100%,60%)",28,2);
  shkDur=.45;slowMo=.3;slowT=.7;
}

/* ═══════════════════════════════════════════
   RENDER
   ═══════════════════════════════════════════ */
function render(now){
  ctx.save();ctx.translate(shkX,shkY);

  // BG gradient
  var g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"#060710");g.addColorStop(.5,"#090c1a");g.addColorStop(1,"#060710");
  ctx.fillStyle=g;ctx.fillRect(-20,-20,W+40,H+40);

  // scanlines
  ctx.fillStyle="rgba(255,255,255,.01)";
  for(var y=0;y<H;y+=3)ctx.fillRect(0,y,W,1);

  if(state==="start")drawStart(now);
  else if(state==="playing"||state==="gameover")drawPlay(now);

  ctx.restore();
}

function drawStart(now){
  // tunnel preview lines
  ctx.strokeStyle="hsla(220,60%,30%,.3)";ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(WALL_PAD,CEIL);ctx.lineTo(W-WALL_PAD,CEIL);ctx.stroke();
  var fy=H-55;
  ctx.beginPath();ctx.moveTo(WALL_PAD,fy);ctx.lineTo(W-WALL_PAD,fy);ctx.stroke();

  ctx.textAlign="center";ctx.textBaseline="middle";
  var tg=ctx.createLinearGradient(W/2-100,0,W/2+100,0);
  tg.addColorStop(0,"hsl(190,100%,65%)");tg.addColorStop(.5,"hsl(270,100%,72%)");tg.addColorStop(1,"hsl(330,100%,68%)");
  ctx.font="bold 40px 'Segoe UI',system-ui,sans-serif";
  ctx.fillStyle=tg;ctx.shadowColor="rgba(120,100,255,.5)";ctx.shadowBlur=18;
  ctx.fillText("NEON",W/2,H*.3);
  ctx.fillText("BOUNCE",W/2,H*.3+44);
  ctx.shadowBlur=0;

  ctx.font="13px 'Segoe UI',system-ui,sans-serif";
  ctx.fillStyle="rgba(150,170,255,.5)";
  ctx.fillText("Flip gravity. Chase perfects. Pulse dash.",W/2,H*.3+82);

  var p=.45+Math.sin(now*.004)*.3;
  ctx.font="17px 'Segoe UI',system-ui,sans-serif";
  ctx.fillStyle="rgba(180,200,255,"+p+")";
  ctx.fillText("Tap to Start",W/2,H*.58);

  if(bestScore>0){
    ctx.font="12px 'Segoe UI',system-ui,sans-serif";
    ctx.fillStyle="rgba(150,170,255,.35)";
    ctx.fillText("Best: "+bestScore,W/2,H*.58+30);
  }

  // demo ball
  var dy=H*.74+Math.sin(now*.003)*18;
  drawBall(W/2,dy,200,now,false);
}

function drawPlay(now){
  // tunnel walls
  var wh=(hue+40)%360;
  ctx.strokeStyle="hsla("+wh+",60%,35%,.4)";ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(WALL_PAD,CEIL);ctx.lineTo(W-WALL_PAD,CEIL);ctx.stroke();
  ctx.beginPath();ctx.moveTo(WALL_PAD,floorY);ctx.lineTo(W-WALL_PAD,floorY);ctx.stroke();
  // side walls
  ctx.strokeStyle="hsla("+wh+",50%,25%,.2)";ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(WALL_PAD,CEIL);ctx.lineTo(WALL_PAD,floorY);ctx.stroke();
  ctx.beginPath();ctx.moveTo(W-WALL_PAD,CEIL);ctx.lineTo(W-WALL_PAD,floorY);ctx.stroke();

  // surfaces
  for(var i=0;i<surfs.length;i++){
    var s=surfs[i];
    if(s.x+s.w<-10||s.x>W+10)continue;
    var sy=s.isTop?CEIL:floorY;
    var a=s.hit?.2:.85;
    var yOff=s.isTop?0:-SURF_H;

    // charge rail glow
    if(s.isCharge&&!s.hit){
      var cp=.4+Math.sin(now*.007+s.x)*.3;
      ctx.fillStyle="hsla(180,100%,78%,"+(cp*a)+")";
    }else{
      ctx.fillStyle="hsla("+s.hue+",65%,45%,"+a+")";
    }
    ctx.fillRect(s.x,sy+yOff,s.w,SURF_H);

    // core strip
    if(!s.hit){
      var csx=s.x+s.w/2-s.coreW/2;
      var coreOff=s.isTop?SURF_H/2:-SURF_H/2;
      ctx.fillStyle="hsla(55,100%,72%,"+(a*.9)+")";
      ctx.fillRect(csx,sy+yOff+SURF_H/2-2,s.coreW,4);
    }

    // glow effect
    if(!s.hit){
      ctx.save();ctx.globalCompositeOperation="lighter";
      ctx.fillStyle="hsla("+s.hue+",100%,55%,.08)";
      ctx.fillRect(s.x-2,sy+yOff-2,s.w+4,SURF_H+4);
      ctx.restore();
    }
  }

  // particles
  ctx.save();ctx.globalCompositeOperation="lighter";
  for(var i=0;i<parts.length;i++){
    var p=parts[i];var al=p.life/p.ml;
    ctx.globalAlpha=al;ctx.fillStyle=p.col;
    ctx.beginPath();ctx.arc(p.x,p.y,p.r*al,0,6.2832);ctx.fill();
  }
  ctx.globalAlpha=1;ctx.globalCompositeOperation="source-over";ctx.restore();

  // shards
  for(var i=0;i<shards.length;i++){
    var s=shards[i];var al=s.life/s.ml;
    ctx.save();ctx.translate(s.x,s.y);ctx.rotate(s.rot);
    ctx.globalAlpha=al;ctx.fillStyle="hsl("+s.hue+",80%,55%)";
    ctx.fillRect(-s.w/2,-s.h/2,s.w,s.h);ctx.restore();
  }
  ctx.globalAlpha=1;

  // ball
  if(state==="playing")drawBall(bx,by,hue,now,pulsing);

  // text pops
  for(var i=0;i<pops.length;i++){
    var t=pops[i];var al=t.life/t.ml;
    ctx.globalAlpha=al;ctx.textAlign="center";ctx.textBaseline="middle";
    ctx.font="bold "+t.sz+"px 'Segoe UI',system-ui,sans-serif";
    ctx.fillStyle=t.col;ctx.shadowColor=t.col;ctx.shadowBlur=6;
    ctx.fillText(t.txt,t.x,t.y);ctx.shadowBlur=0;
  }
  ctx.globalAlpha=1;

  // HUD
  drawHUD(now);

  if(state==="gameover")drawGO(now);
}

function drawBall(x,y,h,now,pulse){
  ctx.save();
  // glow
  ctx.shadowColor="hsl("+h+",100%,65%)";ctx.shadowBlur=16;
  ctx.fillStyle="hsl("+h+",100%,65%)";
  ctx.beginPath();ctx.arc(x,y,BALL_R,0,6.2832);ctx.fill();
  ctx.shadowBlur=0;
  // inner
  ctx.fillStyle="#fff";
  ctx.beginPath();ctx.arc(x,y,BALL_R*.4,0,6.2832);ctx.fill();
  // pulse aura
  if(pulse){
    var ph=(h+50)%360;
    ctx.strokeStyle="hsla("+ph+",100%,75%,"+(0.25+Math.sin(now*.01)*.15)+")";
    ctx.lineWidth=2.5;ctx.beginPath();ctx.arc(x,y,BALL_R+5,0,6.2832);ctx.stroke();
  }
  // gravity arrow
  var gd=gravDir;
  ctx.fillStyle="hsla("+h+",80%,75%,.45)";
  ctx.beginPath();
  var ay=y+(gd>0?BALL_R+4:-BALL_R-4);
  ctx.moveTo(x-3,ay-gd*2.5);ctx.lineTo(x+3,ay-gd*2.5);ctx.lineTo(x,ay+gd*2.5);
  ctx.closePath();ctx.fill();
  ctx.restore();
}

function drawHUD(now){
  ctx.textAlign="left";ctx.textBaseline="top";
  ctx.font="bold 22px 'Segoe UI',system-ui,sans-serif";
  ctx.fillStyle="rgba(200,220,255,.9)";
  ctx.fillText(""+score,16,14);
  if(combo>1){
    ctx.font="13px 'Segoe UI',system-ui,sans-serif";
    ctx.fillStyle="#ffe066";
    ctx.fillText("x"+Math.min(combo,COMBO_CAP)+" combo",16,40);
  }
  // pulse meter
  ctx.textAlign="right";
  ctx.font="11px 'Segoe UI',system-ui,sans-serif";
  var full=pulseChg>=PULSE_NEED;
  ctx.fillStyle=full?"#aaffff":"rgba(150,190,255,.45)";
  ctx.fillText("PULSE",W-16,14);
  var mw=55,mh=5,mx=W-16-mw,my=28;
  ctx.fillStyle="rgba(255,255,255,.08)";ctx.fillRect(mx,my,mw,mh);
  var fill=pulseChg/PULSE_NEED;
  ctx.fillStyle=full?"#aaffff":"hsl(190,75%,48%)";
  ctx.fillRect(mx,my,mw*fill,mh);
  if(full){ctx.shadowColor="#aaffff";ctx.shadowBlur=7;ctx.fillRect(mx,my,mw,mh);ctx.shadowBlur=0}
}

function drawGO(now){
  ctx.fillStyle="rgba(5,5,15,.72)";ctx.fillRect(-20,-20,W+40,H+40);
  ctx.textAlign="center";ctx.textBaseline="middle";

  ctx.font="bold 30px 'Segoe UI',system-ui,sans-serif";
  ctx.fillStyle="#ff4466";ctx.shadowColor="#ff4466";ctx.shadowBlur=12;
  ctx.fillText("SO CLOSE!",W/2,H*.26);ctx.shadowBlur=0;

  if(deathInfo){
    ctx.font="12px 'Segoe UI',system-ui,sans-serif";
    ctx.fillStyle="rgba(200,150,150,.6)";
    ctx.fillText(deathInfo.reason,W/2,H*.26+26);
  }

  ctx.font="14px 'Segoe UI',system-ui,sans-serif";
  ctx.fillStyle="rgba(180,200,255,.5)";ctx.fillText("SCORE",W/2,H*.40-30);
  ctx.font="bold 44px 'Segoe UI',system-ui,sans-serif";
  ctx.fillStyle="#fff";ctx.fillText(""+score,W/2,H*.40+4);

  ctx.font="bold 18px 'Segoe UI',system-ui,sans-serif";
  ctx.fillStyle="#ffe066";ctx.fillText("Best: "+bestScore,W/2,H*.52);

  if(deathInfo){
    ctx.font="12px 'Segoe UI',system-ui,sans-serif";
    ctx.fillStyle="rgba(150,170,210,.5)";
    ctx.fillText("Best combo: "+deathInfo.combo+"  |  Perfect rate: "+deathInfo.rate+"%",W/2,H*.58);
  }

  var rp=.35+Math.sin(now*.004)*.3;
  ctx.font="17px 'Segoe UI',system-ui,sans-serif";
  ctx.fillStyle="rgba(180,200,255,"+rp+")";
  ctx.fillText("Tap to Retry",W/2,H*.70);
}

/* ═══════════════════════════════════════════
   MAIN LOOP
   ═══════════════════════════════════════════ */
var lastT=performance.now();

function loop(now){
  requestAnimationFrame(loop);
  var dt=(now-lastT)/1000;lastT=now;
  if(dt>.1)dt=.1;

  if(state==="playing"){
    acc+=dt;
    var steps=0;
    while(acc>=FDT&&steps<20){step(FDT);acc-=FDT;steps++;if(state!=="playing")break}
  }else if(state==="gameover"){
    acc+=dt;
    var steps2=0;
    while(acc>=FDT&&steps2<20){
      var adt=FDT*slowMo;
      if(shkDur>0){shkDur-=FDT;shkX=(Math.random()-.5)*shkDur*100;shkY=(Math.random()-.5)*shkDur*100;if(shkDur<=0){shkX=0;shkY=0}}
      if(slowT>0){slowT-=FDT;if(slowT<=0)slowMo=1}
      for(var i=parts.length-1;i>=0;i--){
        var p=parts[i];p.x+=p.vx*adt;p.y+=p.vy*adt;p.vy+=180*adt;
        p.life-=FDT;if(p.life<=0)parts.splice(i,1);
      }
      for(var i=pops.length-1;i>=0;i--){
        var t=pops[i];t.y+=t.vy*adt;t.life-=FDT;if(t.life<=0)pops.splice(i,1);
      }
      for(var i=shards.length-1;i>=0;i--){
        var s=shards[i];s.x+=s.vx*adt;s.y+=s.vy*adt;s.vy+=250*adt;
        s.rot+=s.rv*adt;s.life-=FDT;if(s.life<=0)shards.splice(i,1);
      }
      acc-=FDT;steps2++;
    }
  }

  render(now);
}
requestAnimationFrame(loop);

})();
</script>
</body>
</html>
