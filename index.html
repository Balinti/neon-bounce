<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Neon Bounce - Free HTML5 Game</title>
<meta name="description" content="Play Neon Bounce - Tap to bounce a glowing ball between neon platforms. Miss a platform and fall into the void. Platforms get narrower as score increases.">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0014">
<link rel="canonical" href="https://balinti.github.io/neon-bounce/">
<meta property="og:type" content="website">
<meta property="og:title" content="Neon Bounce - Free HTML5 Game">
<meta property="og:description" content="Play Neon Bounce - Tap to bounce a glowing ball between neon platforms. Miss a platform and fall into the void. Platforms get narrower as score increases.">
<meta property="og:url" content="https://balinti.github.io/neon-bounce/">
<meta property="og:image" content="https://balinti.github.io/neon-bounce/og-image.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Neon Bounce - Free HTML5 Game">
<meta name="twitter:description" content="Play Neon Bounce - Tap to bounce a glowing ball between neon platforms. Miss a platform and fall into the void. Platforms get narrower as score increases.">
<meta name="twitter:image" content="https://balinti.github.io/neon-bounce/og-image.jpg">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Neon Bounce",
  "applicationCategory": "Game",
  "operatingSystem": "Web",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "url": "https://balinti.github.io/neon-bounce/",
  "description": "Play Neon Bounce - Tap to bounce a glowing ball between neon platforms. Miss a platform and fall into the void. Platforms get narrower as score increases.",
  "genre": "Casual"
}
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4099346100621490" crossorigin="anonymous"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0014;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;color:#fff;touch-action:manipulation;user-select:none;-webkit-user-select:none}
#wrap{position:relative;margin:0 auto;display:flex;flex-direction:column;overflow:hidden}
#topbar{display:flex;align-items:center;justify-content:space-between;padding:4px 10px;height:32px;background:rgba(10,0,20,0.85);z-index:10;flex-shrink:0}
#topbar .gname{font-size:11px;font-weight:700;letter-spacing:1px;color:rgba(255,255,255,0.5);text-transform:uppercase}
#topbar .tbtns{display:flex;gap:2px}
.tbtn{background:none;border:none;color:rgba(255,255,255,0.6);font-size:15px;cursor:pointer;padding:2px 6px;line-height:1}
.tbtn:hover{color:#fff}
#bottombar{display:flex;align-items:center;justify-content:center;gap:12px;padding:4px 10px;height:28px;background:rgba(10,0,20,0.85);z-index:10;flex-shrink:0}
#bottombar button{background:none;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.5);font-size:10px;padding:2px 10px;border-radius:10px;cursor:pointer}
#bottombar button:hover{color:#fff;border-color:rgba(255,255,255,0.4)}
canvas{display:block;flex:1}
#ui{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:5;pointer-events:none}
#ui.active{pointer-events:auto}
.overlay{display:none;flex-direction:column;align-items:center;gap:10px;text-align:center;padding:20px}
.overlay.show{display:flex}
.overlay h1{font-size:32px;font-weight:900;letter-spacing:2px;text-shadow:0 0 20px currentColor}
.overlay p{font-size:14px;color:rgba(255,255,255,0.6);max-width:280px;line-height:1.4}
.overlay .score-big{font-size:48px;font-weight:900}
.overlay .score-label{font-size:12px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:1px}
.overlay .best-line{font-size:14px;color:rgba(255,255,255,0.5)}
.overlay .tap{font-size:16px;margin-top:8px;animation:pulse 1.5s ease-in-out infinite}
.overlay .reason{font-size:13px;color:rgba(255,100,100,0.8);margin-bottom:2px}
.challenge-text{font-size:12px;color:rgba(255,200,60,0.7);margin-top:4px}
@keyframes pulse{0%,100%{opacity:0.5}50%{opacity:1}}
#helpOverlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.88);z-index:20;display:none;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:20px;text-align:center}
#helpOverlay.show{display:flex}
#helpOverlay h2{font-size:20px;margin-bottom:4px}
#helpOverlay p{font-size:13px;color:rgba(255,255,255,0.7);max-width:300px;line-height:1.5}
#helpOverlay .close-help{margin-top:12px;background:none;border:1px solid rgba(255,255,255,0.3);color:#fff;padding:6px 20px;border-radius:16px;cursor:pointer;font-size:13px}
</style>
</head>
<body>
<div id="wrap">
  <div id="topbar">
    <span class="gname">NEON BOUNCE</span>
    <div class="tbtns">
      <button class="tbtn" id="btnMute" title="Toggle sound"></button>
      <button class="tbtn" id="btnMotion" title="Toggle reduced motion"></button>
      <button class="tbtn" id="btnHelp" title="Help">&#x2753;</button>
    </div>
  </div>
  <canvas id="c"></canvas>
  <div id="bottombar">
    <button id="btnShare">Share</button>
    <button id="btnChallenge">Challenge</button>
  </div>
  <div id="ui">
    <div class="overlay" id="startScreen">
      <h1 id="startTitle">NEON BOUNCE</h1>
      <p>Tap to flip polarity &middot; Match platform color to land</p>
      <div class="tap">Tap to Start</div>
      <div class="challenge-text" id="challengeText" style="display:none"></div>
    </div>
    <div class="overlay" id="overScreen">
      <div class="reason" id="deathReason"></div>
      <div class="score-label">SCORE</div>
      <div class="score-big" id="finalScore">0</div>
      <div class="best-line">Best: <span id="finalBest">0</span></div>
      <div class="tap">Tap to Retry</div>
    </div>
  </div>
  <div id="helpOverlay">
    <h2>How to Play</h2>
    <p>Tap or press Space to flip your ball between <b style="color:hsl(330,100%,60%)">Pink</b> and <b style="color:hsl(185,100%,60%)">Cyan</b>.</p>
    <p>Land on platforms matching your color. Wrong color = game over!</p>
    <p>Build charge with landings. When full, tap to arm a pulse â€” land on any color safely!</p>
    <button class="close-help" id="closeHelp">Got it</button>
  </div>
</div>

<script>
'use strict';
(()=>{

/* ===== DOM refs ===== */
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const wrap=document.getElementById('wrap');
const uiEl=document.getElementById('ui');
const startScreen=document.getElementById('startScreen');
const overScreen=document.getElementById('overScreen');
const startTitle=document.getElementById('startTitle');
const finalScoreEl=document.getElementById('finalScore');
const finalBestEl=document.getElementById('finalBest');
const deathReasonEl=document.getElementById('deathReason');
const challengeTextEl=document.getElementById('challengeText');
const helpOverlay=document.getElementById('helpOverlay');
const btnMute=document.getElementById('btnMute');
const btnMotion=document.getElementById('btnMotion');
const btnHelp=document.getElementById('btnHelp');
const closeHelp=document.getElementById('closeHelp');
const btnShare=document.getElementById('btnShare');
const btnChallenge=document.getElementById('btnChallenge');

/* ===== Settings (persisted) ===== */
let muted=localStorage.getItem('npb_muted')==='1';
let reduceMotion=localStorage.getItem('npb_reduce_motion')==='1';
let best=parseInt(localStorage.getItem('npb_best'))||0;

function updateMuteBtn(){btnMute.textContent=muted?'\u{1F507}':'\u{1F50A}';}
function updateMotionBtn(){btnMotion.textContent=reduceMotion?'\u{26AB}':'\u{2728}';}
updateMuteBtn();updateMotionBtn();

btnMute.onclick=e=>{e.stopPropagation();muted=!muted;localStorage.setItem('npb_muted',muted?'1':'0');updateMuteBtn();};
btnMotion.onclick=e=>{e.stopPropagation();reduceMotion=!reduceMotion;localStorage.setItem('npb_reduce_motion',reduceMotion?'1':'0');updateMotionBtn();};
btnHelp.onclick=e=>{e.stopPropagation();helpOverlay.classList.toggle('show');};
closeHelp.onclick=e=>{e.stopPropagation();helpOverlay.classList.remove('show');};

/* ===== Challenge param ===== */
let challengeScore=0;
const params=new URLSearchParams(location.search);
if(params.has('challenge')){
  challengeScore=parseInt(params.get('challenge'))||0;
  if(challengeScore>0){
    challengeTextEl.textContent='Challenge: beat '+challengeScore;
    challengeTextEl.style.display='block';
  }
}

/* ===== Audio ===== */
let audioCtx=null;
function ensureAudio(){if(!audioCtx){try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}}}
function playTone(freq,dur,type,vol){
  if(muted||!audioCtx)return;
  try{
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.type=type||'sine';o.frequency.value=freq;
    g.gain.setValueAtTime(vol||0.1,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
    o.connect(g);g.connect(audioCtx.destination);
    o.start();o.stop(audioCtx.currentTime+dur);
  }catch(e){}
}
function sfxFlip(){playTone(600,0.06,'square',0.08);}
function sfxLand(){playTone(400,0.08,'triangle',0.1);}
function sfxPerfect(){playTone(800,0.12,'sine',0.12);setTimeout(()=>playTone(1000,0.1,'sine',0.1),60);}
function sfxPulse(){playTone(300,0.2,'sawtooth',0.1);setTimeout(()=>playTone(500,0.15,'sine',0.1),80);}
function sfxDeath(){playTone(150,0.3,'sawtooth',0.15);}
function sfxEdge(){playTone(250,0.06,'square',0.06);}

/* ===== Sizing ===== */
let W,H,dpr;
function resize(){
  const wrapW=Math.min(window.innerWidth,420);
  const wrapH=Math.min(window.innerHeight,750);
  dpr=Math.min(window.devicePixelRatio||1,2);
  wrap.style.width=wrapW+'px';
  wrap.style.height=wrapH+'px';
  const topH=32,botH=28;
  const canH=wrapH-topH-botH;
  canvas.style.width=wrapW+'px';
  canvas.style.height=canH+'px';
  canvas.width=Math.round(wrapW*dpr);
  canvas.height=Math.round(canH*dpr);
  W=wrapW;
  H=canH;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize',resize);
resize();

/* ===== Constants ===== */
const PINK_H=330,CYAN_H=185;
const lanePad=18;
const ballR=10;
const gravity=2200,vyMax=2400,bounceVy=-980,pulseVy=-1320;
const lip=8;

/* ===== Utility ===== */
function clamp(v,lo,hi){return v<lo?lo:v>hi?hi:v;}
function lerp(a,b,t){return a+(b-a)*t;}
function randRange(a,b){return a+Math.random()*(b-a);}
function randSign(){return Math.random()<0.5?-1:1;}

/* ===== Game state ===== */
let state='start';
let ball,platforms,particles,cameraY;
let score,streak,multiplier,charge,pulseReady,pulseArmed;
let hueBase,shakeT,shakeMag,slowmoT,slowmoK,gameTime;
let flipBuffer,coyoteT,coyotePlat,deathReasonText;
let flashAlpha;
let lastTime=0;

/* ===== Platform helpers ===== */
function platWidth(){return clamp(220-1.6*score,92,220);}
function randPol(){return Math.random()<0.5?0:1;}
function platType(){
  const r=Math.random();
  if(score<10)return 'static';
  if(score<25)return r<0.85?'static':'moving';
  if(score<45)return r<0.60?'static':r<0.85?'moving':'fade';
  if(score<70)return r<0.45?'static':r<0.70?'moving':r<0.85?'fade':'cycler';
  return r<0.35?'static':r<0.65?'moving':r<0.80?'fade':'cycler';
}

function makePlatform(y,w,type,pol){
  const half=w/2;
  const minX=lanePad+half;
  const maxX=W-lanePad-half;
  const cx=randRange(Math.min(minX,maxX),Math.max(minX,maxX));
  const p={x:cx,y:y,w:w,h:14,type:type,polarity:pol,life:0,alpha:1,vx:0,cyclePeriod:1.0};
  if(type==='moving'){
    let spd=randSign()*(40+1.2*score);
    if(spd>0)spd=clamp(spd,40,140);
    else spd=clamp(spd,-140,-40);
    p.vx=spd;
  }
  return p;
}

function spawnPlatformBelow(){
  const last=platforms[platforms.length-1];
  const gap=clamp(150+0.9*score,150,250);
  const ny=last.y+gap;
  platforms.push(makePlatform(ny,platWidth(),platType(),randPol()));
}

/* ===== Particles ===== */
function addParticle(x,y,vx,vy,hue,life,size,ring){
  if(particles.length>=240)return;
  particles.push({x,y,vx,vy,hue,life,maxLife:life,size:size||2,ring:!!ring,ringR:0,alpha:1});
}
function spawnLandingSparks(x,y,hue,count){
  for(let i=0;i<count;i++){
    const a=Math.random()*Math.PI*2;
    const sp=randRange(60,220);
    addParticle(x,y,Math.cos(a)*sp,Math.sin(a)*sp-randRange(20,80),hue,randRange(0.2,0.5),randRange(1.5,3));
  }
}
function spawnRing(x,y,hue){addParticle(x,y,0,0,hue,0.35,0,true);}
function spawnFlipSparks(x,y,hue){
  for(let i=0;i<8;i++){
    const a=Math.PI*2*i/8;
    addParticle(x+Math.cos(a)*12,y+Math.sin(a)*12,Math.cos(a)*80,Math.sin(a)*80,hue,0.25,2);
  }
}
function spawnDeathBurst(x,y,hue){
  for(let i=0;i<30;i++){
    const a=Math.random()*Math.PI*2;
    const sp=randRange(100,350);
    addParticle(x,y,Math.cos(a)*sp,Math.sin(a)*sp,hue,randRange(0.3,0.7),randRange(2,4));
  }
  spawnRing(x,y,hue);
}
function spawnEdgeSparks(x,y,hue){
  for(let i=0;i<10;i++){
    addParticle(x,y-randRange(0,10),randSign()*randRange(10,50),-randRange(40,120),hue,randRange(0.15,0.35),randRange(1,2.5));
  }
}

/* ===== Shake & Slowmo ===== */
function triggerShake(mag,t){if(reduceMotion)return;shakeMag=mag;shakeT=t;}
function triggerSlowmo(t,k){if(reduceMotion)return;slowmoT=t;slowmoK=k;}

/* ===== Flip ===== */
function doFlip(){
  ball.polarity=1-ball.polarity;
  const hue=ball.polarity===0?PINK_H:CYAN_H;
  spawnFlipSparks(ball.x,ball.y,hue);
  sfxFlip();
}

/* ===== Init ===== */
function initGame(){
  score=0;streak=0;multiplier=1;charge=0;
  pulseReady=false;pulseArmed=false;
  hueBase=0;shakeT=0;shakeMag=0;slowmoT=0;slowmoK=1;gameTime=0;
  flipBuffer=0;coyoteT=0;coyotePlat=null;deathReasonText='';
  flashAlpha=0;
  ball={x:W/2,y:H*0.3,vx:0,vy:0,polarity:0,prevBottom:0};
  ball.prevBottom=ball.y+ballR;
  cameraY=ball.y-H*0.42;
  platforms=[];
  particles=[];
  // initial platform right under ball
  platforms.push(makePlatform(ball.y+60,220,'static',ball.polarity));
  // fill below
  let lastY=ball.y+60;
  for(let i=0;i<14;i++){
    lastY+=clamp(150+0.9*score,150,250);
    platforms.push(makePlatform(lastY,platWidth(),platType(),randPol()));
  }
}

/* ===== Input ===== */
function handleTap(){
  ensureAudio();
  if(state==='start'){
    state='playing';
    uiEl.classList.remove('active');
    startScreen.classList.remove('show');
    initGame();
    return;
  }
  if(state==='gameover'){
    state='playing';
    uiEl.classList.remove('active');
    overScreen.classList.remove('show');
    initGame();
    return;
  }
  if(state==='playing'){
    if(pulseReady&&!pulseArmed){
      pulseArmed=true;
      sfxPulse();
      doFlip();
    }else{
      doFlip();
    }
    flipBuffer=0.12;
  }
}

canvas.addEventListener('pointerdown',e=>{e.preventDefault();handleTap();});
document.addEventListener('keydown',e=>{
  if(e.code==='Space'||e.code==='Enter'){e.preventDefault();handleTap();}
});

/* ===== Game Over ===== */
function gameOver(reason){
  state='gameover';
  deathReasonText=reason;
  if(score>best){best=score;localStorage.setItem('npb_best',''+best);}
  deathReasonEl.textContent=reason;
  finalScoreEl.textContent=score;
  finalBestEl.textContent=best;
  overScreen.classList.add('show');
  uiEl.classList.add('active');
  const hue=ball.polarity===0?PINK_H:CYAN_H;
  spawnDeathBurst(ball.x,ball.y,hue);
  triggerShake(10,0.20);
  flashAlpha=0.6;
  sfxDeath();
  // auto share on milestones
  if(score===best&&best>0&&(best===25||best===45||best===70)&&navigator.share){
    setTimeout(()=>shareGame('I just hit '+score+' in Neon Bounce!'),600);
  }
}

/* ===== Share ===== */
function shareGame(text){
  const url='https://balinti.github.io/neon-bounce/?challenge='+Math.max(score,best);
  if(navigator.share){
    navigator.share({title:'Neon Bounce',text:text,url:url}).catch(()=>{});
  }else{
    try{navigator.clipboard.writeText(text+' '+url);}catch(e){}
  }
}
btnShare.onclick=e=>{e.stopPropagation();shareGame('I scored '+score+' in Neon Bounce! Can you beat me?');};
btnChallenge.onclick=e=>{e.stopPropagation();shareGame('Challenge: beat '+Math.max(score,best)+' in Neon Bounce!');};

/* ===== Update ===== */
function update(dt){
  if(state!=='playing')return;
  gameTime+=dt;

  // Slow-mo
  let adt=dt;
  if(slowmoT>0){slowmoT-=dt;adt=dt*slowmoK;}

  // Shake decay
  if(shakeT>0)shakeT-=dt;

  // Flash decay
  if(flashAlpha>0)flashAlpha=Math.max(0,flashAlpha-dt*3);

  // Flip buffer + coyote decay
  if(flipBuffer>0)flipBuffer-=dt;
  if(coyoteT>0)coyoteT-=dt;

  // Difficulty drift
  const driftAx=Math.min(700+18*score,1900);
  const wind=clamp(Math.sin(gameTime*0.9)*(40+1.2*score),-160,160);
  const ax=(ball.polarity===0?-1:1)*driftAx*0.12+wind;
  ball.vx+=ax*adt;

  // Gravity
  ball.vy+=gravity*adt;
  ball.vy=clamp(ball.vy,-vyMax,vyMax);

  // Save previous bottom
  ball.prevBottom=ball.y+ballR;

  // Move
  ball.x+=ball.vx*adt;
  ball.y+=ball.vy*adt;

  // Wall bounce
  if(ball.x-ballR<lanePad){ball.x=lanePad+ballR;ball.vx=Math.abs(ball.vx)*0.7;}
  if(ball.x+ballR>W-lanePad){ball.x=W-lanePad-ballR;ball.vx=-Math.abs(ball.vx)*0.7;}

  // Update platforms
  for(const p of platforms){
    p.life+=adt;
    if(p.type==='moving'){
      p.x+=p.vx*adt;
      const halfW=p.w/2;
      if(p.x-halfW<lanePad){p.x=lanePad+halfW;p.vx=Math.abs(p.vx);}
      if(p.x+halfW>W-lanePad){p.x=W-lanePad-halfW;p.vx=-Math.abs(p.vx);}
    }
    if(p.type==='fade'){
      if(p.life>0.8)p.alpha=Math.max(0.25,1-(p.life-0.8)*0.9);
    }
    if(p.type==='cycler'){
      p.polarity=Math.floor(p.life/p.cyclePeriod)%2;
    }
  }

  // Coyote near-landing detect
  if(ball.vy>0){
    for(const p of platforms){
      if(p.type==='fade'&&p.alpha<0.3)continue;
      const pTop=p.y;
      const ballBot=ball.y+ballR;
      if(pTop>ballBot&&pTop-ballBot<26){
        const halfW=p.w/2+lip;
        if(ball.x>p.x-halfW&&ball.x<p.x+halfW){
          coyoteT=0.10;
          coyotePlat=p;
        }
      }
    }
  }

  // Consume buffered flip + coyote
  if(flipBuffer>0&&coyoteT>0&&coyotePlat){
    flipBuffer=0;coyoteT=0;
  }

  // Collision (only when falling)
  if(ball.vy>0){
    const ballBot=ball.y+ballR;
    for(const p of platforms){
      if(p.type==='fade'&&p.alpha<0.3)continue;
      const pTop=p.y;
      // Crossing check: prev bottom was above pTop, now at or below
      if(ball.prevBottom<=pTop&&ballBot>=pTop){
        const halfW=p.w/2;
        // Closest point on platform horizontal extent to ball.x
        const closestX=clamp(ball.x,p.x-halfW,p.x+halfW);
        const dx=Math.abs(ball.x-closestX);
        if(dx<ballR+lip){
          // Polarity check
          const colorMatch=(ball.polarity===p.polarity);
          if(!colorMatch&&!pulseArmed){
            gameOver('Wrong polarity!');
            return;
          }
          // Edge-grab detection
          const isEdge=dx>=ballR;
          const polHue=ball.polarity===0?PINK_H:CYAN_H;
          if(isEdge){
            ball.vx*=0.3;
            spawnEdgeSparks(ball.x,pTop,polHue);
            triggerSlowmo(0.15,0.65);
            sfxEdge();
          }

          // Land
          ball.y=pTop-ballR;
          const wasPulse=pulseArmed;
          if(pulseArmed){
            ball.vy=pulseVy;
            pulseArmed=false;pulseReady=false;charge=0;
            triggerShake(9,0.14);
          }else{
            ball.vy=bounceVy;
          }

          // Perfect landing
          const off=Math.abs(ball.x-p.x)/(p.w/2||1);
          const isPerfect=off<=0.18;

          // Scoring
          let pts=1;
          if(isPerfect)pts+=1;
          streak++;
          multiplier=Math.min(1+Math.floor(streak/6),6);
          pts*=multiplier;
          score+=pts;

          // Charge
          charge=Math.min(charge+(isPerfect?0.22:0.12),1);
          if(charge>=1)pulseReady=true;

          // FX
          if(isPerfect){
            spawnLandingSparks(ball.x,pTop,polHue,24);
            spawnRing(ball.x,pTop,polHue);
            triggerShake(6,0.12);
            sfxPerfect();
          }else if(wasPulse){
            spawnLandingSparks(ball.x,pTop,60,24);
            spawnRing(ball.x,pTop,60);
            triggerShake(9,0.14);
            sfxPulse();
          }else{
            spawnLandingSparks(ball.x,pTop,polHue,14);
            triggerShake(3,0.08);
            sfxLand();
          }
          break;
        }
      }
    }
  }

  // Camera follow
  const targetCam=ball.y-H*0.42;
  cameraY=lerp(cameraY,targetCam,1-Math.pow(0.001,dt));

  // Spawn platforms below view
  const bottomEdge=cameraY+H+200;
  while(platforms.length>0&&platforms[platforms.length-1].y<bottomEdge){
    spawnPlatformBelow();
  }
  // Cull above
  while(platforms.length>0&&platforms[0].y<cameraY-100){
    platforms.shift();
  }

  // Fell off bottom
  if(ball.y-cameraY>H+100){
    gameOver('Fell into the void!');
    return;
  }

  // Update particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.life-=dt;
    if(p.life<=0){particles.splice(i,1);continue;}
    p.alpha=p.life/p.maxLife;
    if(p.ring){p.ringR+=300*dt;}
    else{p.x+=p.vx*dt;p.y+=p.vy*dt;p.vy+=600*dt;}
  }

  hueBase+=8*dt;
}

/* ===== Render helpers ===== */
function roundRect(c,x,y,w,h,r){
  c.moveTo(x+r,y);
  c.lineTo(x+w-r,y);
  c.quadraticCurveTo(x+w,y,x+w,y+r);
  c.lineTo(x+w,y+h-r);
  c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  c.lineTo(x+r,y+h);
  c.quadraticCurveTo(x,y+h,x,y+h-r);
  c.lineTo(x,y+r);
  c.quadraticCurveTo(x,y,x+r,y);
}

function polHue(pol){return pol===0?PINK_H:CYAN_H;}

/* ===== Draw ===== */
function draw(){
  ctx.save();
  ctx.clearRect(0,0,W,H);

  // Background gradient
  const h1=hueBase%360;
  const h2=(hueBase+40)%360;
  const bgGrad=ctx.createLinearGradient(0,0,0,H);
  bgGrad.addColorStop(0,'hsl('+h1+',30%,4%)');
  bgGrad.addColorStop(1,'hsl('+h2+',40%,8%)');
  ctx.fillStyle=bgGrad;
  ctx.fillRect(0,0,W,H);

  // Shake offset
  let sx=0,sy=0;
  if(shakeT>0&&!reduceMotion){
    const intensity=shakeMag*(shakeT/0.2);
    sx=(Math.random()-0.5)*intensity*2;
    sy=(Math.random()-0.5)*intensity*2;
  }
  ctx.translate(sx,sy);

  const camOff=-cameraY;

  // Draw platforms
  for(const p of platforms){
    const py=p.y+camOff;
    if(py<-30||py>H+30)continue;
    const hue=polHue(p.polarity);
    const alpha=p.type==='fade'?p.alpha:1;

    // Glow pass
    ctx.save();
    ctx.globalAlpha=alpha*0.25;
    ctx.fillStyle='hsl('+hue+',100%,60%)';
    ctx.beginPath();
    roundRect(ctx,p.x-p.w/2-4,py-4,p.w+8,p.h+8,10);
    ctx.fill();
    ctx.restore();

    // Core
    ctx.save();
    ctx.globalAlpha=alpha;
    ctx.fillStyle='hsl('+hue+',100%,60%)';
    ctx.beginPath();
    roundRect(ctx,p.x-p.w/2,py,p.w,p.h,6);
    ctx.fill();

    // Inner highlight
    ctx.fillStyle='hsla(0,0%,100%,0.12)';
    ctx.beginPath();
    roundRect(ctx,p.x-p.w/2+2,py+1,p.w-4,p.h/2-1,4);
    ctx.fill();

    // Cycler symbol
    if(p.type==='cycler'){
      ctx.fillStyle='rgba(255,255,255,0.35)';
      ctx.font='bold 9px sans-serif';
      ctx.textAlign='center';
      ctx.textBaseline='middle';
      ctx.fillText('\u21BB',p.x,py+p.h/2+1);
    }
    // Moving arrow
    if(p.type==='moving'){
      ctx.fillStyle='rgba(255,255,255,0.2)';
      ctx.font='8px sans-serif';
      ctx.textAlign='center';
      ctx.textBaseline='middle';
      ctx.fillText(p.vx>0?'\u25B6':'\u25C0',p.x,py+p.h/2);
    }
    ctx.restore();
  }

  // Draw ball
  if(state==='playing'||state==='gameover'){
    const by=ball.y+camOff;
    const hue=polHue(ball.polarity);

    // Outer glow
    ctx.save();
    ctx.shadowColor='hsl('+hue+',100%,60%)';
    ctx.shadowBlur=18;
    ctx.beginPath();
    ctx.arc(ball.x,by,ballR+4,0,Math.PI*2);
    ctx.fillStyle='hsla('+hue+',100%,60%,0.2)';
    ctx.fill();
    ctx.shadowBlur=0;
    ctx.restore();

    // Core ball
    ctx.beginPath();
    ctx.arc(ball.x,by,ballR,0,Math.PI*2);
    ctx.fillStyle='hsl('+hue+',100%,70%)';
    ctx.fill();

    // Inner highlight
    ctx.beginPath();
    ctx.arc(ball.x-2,by-2,ballR*0.45,0,Math.PI*2);
    ctx.fillStyle='hsla(0,0%,100%,0.3)';
    ctx.fill();

    // Pulse armed ring
    if(pulseArmed){
      ctx.save();
      const pa=0.5+0.5*Math.sin(gameTime*12);
      ctx.strokeStyle='hsla(60,100%,70%,'+pa+')';
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.arc(ball.x,by,ballR+7,0,Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }
  }

  // Draw particles
  for(const p of particles){
    const py=p.y+camOff;
    if(py<-30||py>H+30)continue;
    if(p.ring){
      ctx.save();
      ctx.globalAlpha=p.alpha*0.5;
      ctx.strokeStyle='hsl('+p.hue+',100%,70%)';
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.arc(p.x,py,p.ringR,0,Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }else{
      ctx.save();
      ctx.globalAlpha=p.alpha;
      ctx.fillStyle='hsl('+p.hue+',100%,70%)';
      ctx.beginPath();
      ctx.arc(p.x,py,p.size,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
  }

  // Undo shake translation
  ctx.translate(-sx,-sy);

  // Death flash overlay
  if(flashAlpha>0){
    ctx.save();
    ctx.globalAlpha=flashAlpha;
    ctx.fillStyle='#fff';
    ctx.fillRect(0,0,W,H);
    ctx.restore();
  }

  // HUD (drawn in screen space, not camera space)
  if(state==='playing'){
    ctx.save();
    // Score center top
    ctx.fillStyle='rgba(255,255,255,0.9)';
    ctx.font='bold 28px sans-serif';
    ctx.textAlign='center';
    ctx.textBaseline='top';
    ctx.fillText(''+score,W/2,10);

    // Multiplier + streak
    if(multiplier>1){
      ctx.font='bold 13px sans-serif';
      ctx.fillStyle='rgba(255,255,100,0.8)';
      ctx.fillText('x'+multiplier+'  streak '+streak,W/2,42);
    }

    // Charge bar
    const barW=60,barH=5,barX=W/2-barW/2,barY=multiplier>1?60:46;
    ctx.fillStyle='rgba(255,255,255,0.12)';
    ctx.fillRect(barX,barY,barW,barH);
    const chHue=pulseReady?60:200;
    const chA=pulseReady?(0.7+0.3*Math.sin(gameTime*10)):0.7;
    ctx.fillStyle='hsla('+chHue+',100%,60%,'+chA+')';
    ctx.fillRect(barX,barY,barW*charge,barH);

    if(pulseReady&&!pulseArmed){
      ctx.font='bold 10px sans-serif';
      ctx.fillStyle='hsla(60,100%,70%,'+(0.6+0.4*Math.sin(gameTime*8))+')';
      ctx.textAlign='center';
      ctx.fillText('PULSE READY',W/2,barY+14);
    }
    if(pulseArmed){
      ctx.font='bold 10px sans-serif';
      ctx.fillStyle='hsla(60,100%,70%,'+(0.6+0.4*Math.sin(gameTime*12))+')';
      ctx.textAlign='center';
      ctx.fillText('PULSE ARMED',W/2,barY+14);
    }

    // Best top-right
    if(best>0){
      ctx.font='10px sans-serif';
      ctx.fillStyle='rgba(255,255,255,0.3)';
      ctx.textAlign='right';
      ctx.fillText('BEST '+best,W-10,18);
    }
    ctx.restore();
  }

  ctx.restore();
}

/* ===== Start screen ===== */
function showStart(){
  state='start';
  startScreen.classList.add('show');
  uiEl.classList.add('active');
  overScreen.classList.remove('show');
  // Animate title color
  const colors=['hsl(330,100%,60%)','hsl(185,100%,60%)'];
  let ci=0;
  startTitle.style.color=colors[0];
  const iv=setInterval(()=>{
    if(state!=='start'){clearInterval(iv);return;}
    ci=1-ci;
    startTitle.style.color=colors[ci];
  },1200);
}

/* ===== Main loop ===== */
function gameLoop(ts){
  requestAnimationFrame(gameLoop);
  const rawDt=(ts-lastTime)/1000;
  lastTime=ts;
  const dt=Math.min(rawDt,0.05);
  // Flash decay even outside playing
  if(flashAlpha>0)flashAlpha=Math.max(0,flashAlpha-dt*3);
  // HueBase ticks always for bg animation
  if(state!=='playing')hueBase=(hueBase||0)+8*dt;
  update(dt);
  draw();
}

showStart();
hueBase=0;
requestAnimationFrame(ts=>{lastTime=ts;gameLoop(ts);});

})();
</script>
</body>
</html>
